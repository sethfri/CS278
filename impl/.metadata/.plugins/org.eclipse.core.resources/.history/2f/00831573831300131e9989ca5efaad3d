package org.cs27x.dropbox.test;

import org.cs27x.dropbox.DefaultFileManager;

import java.io.IOException;
import java.io.InputStream;
import java.io.File;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import static org.junit.Assert.*;

import org.junit.Before;
import org.junit.Test;

public class DefaultFileManagerTest {
	
	private Path watchedPath;
	private Path testFilePath;
	private DefaultFileManager defaultFileManager;

	@Before
	public void setUp() throws Exception {
		this.watchedPath = Paths.get("C:", "Users", "Seth Friedman",
				"Desktop", "Developer", "CS278", "impl", "Asgn2", "test");
		
		this.testFilePath = Paths.get(this.watchedPath.toString(), "writeTest.txt");
		
		if (!Files.exists(this.watchedPath)) {
			new File(this.watchedPath.toString()).mkdir();
		}
		
		this.defaultFileManager = new DefaultFileManager(this.watchedPath);
	}

	@Test
	public void testPathExistence() {
		assertTrue(this.defaultFileManager.exists(this.watchedPath));
	}
	
	@Test
	public void testWrite() throws IOException {
		String stringToWrite = "Hello World";
		this.defaultFileManager.write(this.testFilePath, stringToWrite.getBytes(), true);
		
		// Get the file contents of writeTest.txt
		InputStream inputStream = Files.newInputStream(this.watchedPath);
		
		String stringFromFile = this.getFileContents(inputStream);
		
		inputStream.close();
		
		assertEquals(stringToWrite, stringFromFile);
		
		this.defaultFileManager.write(this.testFilePath, stringToWrite.getBytes(), false);
		
		inputStream = Files.newInputStream(this.watchedPath);
		
		String updatedStringFromFile = this.getFileContents(inputStream);
		
		inputStream.close();
		
		assertEquals(updatedStringFromFile, stringFromFile);
	}
	
	private String getFileContents(InputStream inputStream) throws IOException {
		String contentsString = "";
		
		while (inputStream.available() != 0) {
			contentsString += inputStream.read();
		}
		
		return contentsString;
	}
	
	@Test
	public void testDeletion() throws IOException {
		this.defaultFileManager.delete(this.watchedPath);
		
		assertFalse(this.defaultFileManager.exists(this.watchedPath));
	}
}
